<project name="ccp-common" default="build" basedir="..">
	<import file=".build-scripts/build-codeqa-tasks.xml" />
	<import file=".build-scripts/build-dependencies.xml" />

	<!-- List internal project dependencies here (comma-delimited) -->
	<property name="dependency.list" value="" />

	<property name="project.name" value="${ant.project.name}" />
	<property name="test-resources.jar.name" value="${project.name}-test-resources.jar" />
	<property name="code-analysis.dir" value=".code-analysis" />
	<property name="dependency.build.dir" value=".build" />

	<!-- Project Directories -->
	<property name="ant.dir" value="ant" />
	<property name="ant.external.lib.dir" value="${ant.dir}/lib" />
	<property name="source.dir" value="src" />
	<property name="test.source.dir" value="test" />
	<property name="build.dir" value="build" />
	<property name="docs.dir" value="doc" />
	<property name="classes.dir" value="${build.dir}/classes" />
	<property name="distribution.dir" value="${build.dir}/distribution" />
	<property name="lib.dir" value="lib" />
	<property name="lib-test.dir" value="lib-test" />

	<!-- Import SVN user information - NOTE: PLEASE DO NOT REDISTRIBUTE THE build.properties FILE -->
	<property file="ant/build.properties-DO_NOT_REDISTRIBUTE" />

	<path id="svn.classpath">
		<fileset dir="${ant.external.lib.dir}">
			<include name="**/svn*.jar" />
		</fileset>
	</path>
	<typedef resource="org/tigris/subversion/svnant/svnantlib.xml" classpathref="svn.classpath" />

	<path id="ant.contrib.classpath">
		<fileset dir="${ant.external.lib.dir}">
			<include name="**/ant-contrib*.jar" />
		</fileset>
	</path>
	<taskdef resource="net/sf/antcontrib/antcontrib.properties" classpathref="ant.contrib.classpath" />

	<target name="init">
		<antcall target="package-test-resources" />
	</target>

	<!-- The compile classpath contains jars necessary for compile- and run-time. -->
	<target name="set.compile.time.classpath">
	<path id="compile.classpath">
		<fileset dir="${lib.dir}">
			<include name="**/*.jar" />
		</fileset>
		<fileset dir="${distribution.dir}">
					<include name="**/*.jar" />
				</fileset>
	</path>
	<property name="compile.classpath.property" refid="compile.classpath" />
		</target>


	<path id="compile.test.classpath">
		<fileset dir="${lib-test.dir}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<!-- Packages the test resources into a JAR file -->
	<target name="package-test-resources" description="Packages non-java files in the test.source directory. These files are required to run the unit tests, and thus must be on the classpath.">
		<echo message="Packaging the test resources..." />
		<jar destFile="${lib-test.dir}/${test-resources.jar.name}">
			<fileset dir="${test.source.dir}">
				<include name="**/*.*" />
				<exclude name="**/*.java" />
			</fileset>
		</jar>
	</target>

	<target name="cleanup-postbuild">
		<delete file="${lib-test.dir}/${test-resources.jar.name}" />
	</target>

	<!-- Build and run unit tests only (no functional tests) -->
	<target name="build" depends="init,clean,build.dependencies,compile,run.unit.tests,package-project,cleanup-postbuild" description="Builds the project, runs all unit tests and packages into a jar file if the tests are successful." />

	<!-- Build and run code analyses -->
	<target name="build.code.analysis" depends="init,clean,build.dependencies,compile,run.unit.tests,package-project,complete.code.analysis,cleanup-postbuild" description="Builds the project and runs all source code analyses." />

	<!-- Deletes compiled and generated code -->
	<target name="clean" description="Deletes compiled and generated code">
		<delete dir="${build.dir}" />
	</target>

	<!-- Compiles the Java code -->
	<target name="compile" depends="set.compile.time.classpath" description="Compiles the Java code">
		<echo message="BASE DIRECTORY = ${basedir}" />
		<mkdir dir="${build.dir}" />
		<mkdir dir="${classes.dir}" />

		<javac srcdir="${source.dir}" destdir="${classes.dir}" debug="on" deprecation="off">
			<classpath refid="compile.classpath" />
		</javac>

		<javac srcdir="${test.source.dir}" destdir="${classes.dir}" debug="on" deprecation="off">
			<classpath refid="compile.classpath" />
			<classpath refid="compile.test.classpath" />
		</javac>

		<copy todir="${classes.dir}">
			<fileset dir="${source.dir}">
				<include name="**/*.properties" />
				<include name="**/*.xml" />
			</fileset>
		</copy>
	</target>

	<!-- Packages the project into a JAR file -->
	<target name="package-project" depends="compile" description="Packages the files into a JAR file">
		<mkdir dir="${distribution.dir}" />
		<echo message="Packaging the project..." />
		<svn username="${svn.build.user}" password="${svn.build.passwd}" svnkit="true">
			<wcversion path="${basedir}" />
		</svn>
		<propertyregex property="branch.name" input="${repository.path}" regexp="/([^/]+)$" select="\1" />
		<echo message="${repository.path}" />
		<jar destFile="${distribution.dir}/${project.name}-${branch.name}-${committed.max-with-flags}.jar">
			<fileset dir="${classes.dir}">
				<include name="**/*.*" />
				<exclude name="**/*Test.*" />
				<exclude name="**/*TestFn.*" />
			</fileset>
		</jar>
	</target>

	<!-- Builds the Javadocs -->
	<target name="create-javadoc" depends="set.compile.time.classpath">
		<javadoc packagenames="edu.uchsc.ccp.*" sourcepath="${source.dir}" destdir="${docs.dir}/api" windowtitle="Center for Computational Pharmacology Biomedical Discovery Accelerator API" linksource="true">
			<classpath>
				<path refid="compile.classpath" />
				<pathelement location="${classes.dir}" />
			</classpath>
			<link href="http://java.sun.com/j2se/1.5.0/docs/api/" />
			<doctitle>
				<![CDATA[<h1>Center for Computational Pharmacology API</h1>]]>
			</doctitle>
	</javadoc>
</target>




</project>
